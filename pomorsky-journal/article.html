// КОД ДЛЯ ЗАГРУЗКИ СТАТЬИ
async function loadArticle() {
    try {
        console.log('Начинаем загрузку статьи...');
        
        // Получаем slug из URL
        const urlParams = new URLSearchParams(window.location.search);
        const articleSlug = urlParams.get('slug');
        
        console.log('Получен slug из URL:', articleSlug);
        
        if (!articleSlug) {
            console.error('Slug не найден в URL');
            document.getElementById('articleContainer').innerHTML = '<p>Статья не найдена (отсутствует slug в URL).</p>';
            return;
        }

        // Загружаем список статей
        console.log('Загружаем articles-list.json...');
        const response = await fetch('articles-list.json');
        
        if (!response.ok) {
            throw new Error(`Ошибка загрузки списка статей: ${response.status}`);
        }
        
        const articles = await response.json();
        console.log('Статьи загружены:', articles);
        
        // Ищем статью по slug
        const article = articles.find(a => a.slug === articleSlug);
        
        if (!article) {
            console.error('Статья не найдена в списке:', articleSlug);
            document.getElementById('articleContainer').innerHTML = '<p>Статья не найдена в списке.</p>';
            return;
        }

        console.log('Найдена статья:', article);
        
        // Пробуем загрузить markdown разными способами
        let markdownText = '';
        
        // Вариант 1: Пробуем загрузить из указанного файла
        if (article.contentFile) {
            console.log('Пробуем загрузить из contentFile:', article.contentFile);
            try {
                const mdResponse = await fetch(article.contentFile);
                if (mdResponse.ok) {
                    markdownText = await mdResponse.text();
                    console.log('Файл загружен из contentFile');
                }
            } catch (error) {
                console.warn('Не удалось загрузить из contentFile:', error);
            }
        }
        
        // Вариант 2: Пробуем стандартный путь (articles/{slug}.md)
        if (!markdownText) {
            const standardPath = `articles/${articleSlug}.md`;
            console.log('Пробуем стандартный путь:', standardPath);
            try {
                const mdResponse = await fetch(standardPath);
                if (mdResponse.ok) {
                    markdownText = await mdResponse.text();
                    console.log('Файл загружен из стандартного пути');
                } else {
                    console.error('Файл не найден по стандартному пути:', standardPath);
                }
            } catch (error) {
                console.warn('Ошибка загрузки по стандартному пути:', error);
            }
        }
        
        if (!markdownText) {
            throw new Error(`Не удалось загрузить файл статьи "${articleSlug}.md". Проверьте, существует ли файл в папке articles/`);
        }

        console.log('Markdown загружен, длина:', markdownText.length);
        
        // Преобразуем markdown в HTML
        marked.setOptions({
            gfm: true,
            breaks: true,
            sanitize: false,
            langPrefix: 'language-'
        });
        
        const contentHtml = marked.parse(markdownText);
        console.log('Markdown преобразован в HTML');
        
        displayArticle(article, contentHtml);
        
    } catch (error) {
        console.error('Ошибка загрузки статьи:', error);
        document.getElementById('articleContainer').innerHTML = 
            `<div style="text-align: center; padding: 40px; color: #c62828;">
                <h3>Ошибка загрузки статьи</h3>
                <p>${error.message}</p>
                <p>Проверьте:</p>
                <ul style="text-align: left; max-width: 500px; margin: 20px auto;">
                    <li>Существует ли файл <strong>articles/${getSlugFromUrl()}.md</strong>?</li>
                    <li>Правильно ли указан slug в articles-list.json?</li>
                    <li>Находится ли файл в папке <strong>articles/</strong>?</li>
                </ul>
                <p><a href="index.html" style="color: #1a237e;">← Вернуться к списку статей</a></p>
            </div>`;
    }
}

function getSlugFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('slug') || 'unknown';
}

function displayArticle(article, contentHtml) {
    const container = document.getElementById('articleContainer');
    
    if (!container) {
        console.error('Контейнер статьи не найден!');
        return;
    }
    
    // Обновляем заголовок страницы
    document.title = `${article.title} - Инакой`;
    
    container.innerHTML = `
        <div class="article-header">
            <h1 class="article-title">${article.title}</h1>
            <div class="article-meta">
                <span class="article-category">${article.category}</span>
                <span class="article-author">${article.author}</span>
                <span class="article-date">${formatDate(article.date)}</span>
            </div>
        </div>
        <div class="article-content">
            ${contentHtml}
        </div>
    `;
}

function formatDate(dateString) {
    try {
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        return new Date(dateString).toLocaleDateString('ru-RU', options);
    } catch (e) {
        return dateString;
    }
}

// Загружаем статью при загрузке страницы
document.addEventListener('DOMContentLoaded', loadArticle);
